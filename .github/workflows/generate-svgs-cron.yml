name: Generate SVGs Cron

on:
  schedule:
    # Roda √†s 3h07 da manh√£ UTC (00h07 hor√°rio de Bras√≠lia)
    - cron: "7 3 * * *"
  workflow_dispatch: # Permite execu√ß√£o manual no GitHub

jobs:
  generate-svgs:
    runs-on: ubuntu-latest
    steps:
      - name: Regenerate all due SVGs (loop)
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          RAILWAY_URL: ${{ secrets.RAILWAY_URL }}
        run: |
          if [ -z "$CRON_SECRET" ]; then
            echo "‚ùå CRON_SECRET n√£o configurado"
            exit 1
          fi

          if [ -z "$RAILWAY_URL" ]; then
            echo "‚ùå RAILWAY_URL n√£o configurado"
            exit 1
          fi

          # Get initial stats
          echo "üìä Checking SVG status..."
          echo "üîó Railway URL: ${RAILWAY_URL}"
          echo "üîë CRON_SECRET configured: $([ -n "$CRON_SECRET" ] && echo "YES" || echo "NO")"

          STATS=$(curl -v -fsS --max-time 30 \
            -H "Authorization: Bearer ${CRON_SECRET}" \
            "${RAILWAY_URL}/api/cron/debug" 2>&1 || echo '{"totalSvgs":0,"dueSvgs":0,"pausedSvgs":0,"futureSvgs":0,"hasMore":false}')

          echo "üìÑ Raw response: $STATS"

          TOTAL=$(echo "$STATS" | grep -o '"totalSvgs":"[0-9]*"' | cut -d'"' -f4)
          DUE=$(echo "$STATS" | grep -o '"dueSvgs":"[0-9]*"' | cut -d'"' -f4)
          PAUSED=$(echo "$STATS" | grep -o '"pausedSvgs":"[0-9]*"' | cut -d'"' -f4)
          FUTURE=$(echo "$STATS" | grep -o '"futureSvgs":"[0-9]*"' | cut -d'"' -f4)

          echo "üìà Total SVGs: ${TOTAL:-0}"
          echo "‚è∞ Due for regeneration: ${DUE:-0}"
          echo "‚è∏Ô∏è  Paused: ${PAUSED:-0}"
          echo "üìÖ Future regeneration: ${FUTURE:-0}"

          if [ "${DUE:-0}" -eq 0 ]; then
            echo "‚úÖ No SVGs due for regeneration, exiting"
            exit 0
          fi

          echo ""
          echo "üîÑ Starting regeneration loop... (${DUE:-0} SVGs to process)"

          PROCESSED=0
          START_TIME=$(date +%s)

          # Loop at√© n√£o haver mais SVGs para processar
          for i in {1..20}; do
            echo "üì¶ Run $i"

            # Calculate elapsed time
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            ELAPSED_MIN=$((ELAPSED / 60))
            ELAPSED_SEC=$((ELAPSED % 60))

            echo "‚è±Ô∏è  Elapsed: ${ELAPSED_MIN}m ${ELAPSED_SEC}s | Processed so far: ${PROCESSED}"

            RES=$(curl -fsS --retry 5 --retry-all-errors --max-time 420 \
              -X POST \
              -H "Authorization: Bearer ${CRON_SECRET}" \
              -H "Content-Type: application/json" \
              "${RAILWAY_URL}/api/cron/generate-svgs?limit=50&timeboxMs=360000" || echo '{"hasMore":false,"claimed":0,"generated":0,"skipped":0,"failed":0}')

            # Extract stats from response
            CLAIMED=$(echo "$RES" | grep -o '"claimed":[0-9]*' | cut -d':' -f2)
            GENERATED=$(echo "$RES" | grep -o '"generated":[0-9]*' | cut -d':' -f2)
            SKIPPED=$(echo "$RES" | grep -o '"skipped":[0-9]*' | cut -d':' -f2)
            FAILED=$(echo "$RES" | grep -o '"failed":[0-9]*' | cut -d':' -f2)

            if [ "${CLAIMED:-0}" -gt 0 ]; then
              PROCESSED=$((PROCESSED + GENERATED))
              echo "üìä This run: ${CLAIMED} claimed, ${GENERATED} generated, ${SKIPPED} skipped, ${FAILED} failed"
            fi

            echo "$RES"

            # Se o endpoint indicar que n√£o h√° mais trabalho, sai
            if echo "$RES" | grep -q '"hasMore":false'; then
              echo "‚úÖ No more SVGs to process, exiting loop"
              break
            fi

            # Pequena pausa entre requests
            sleep 5
          done

          # Final summary
          END_TIME=$(date +%s)
          TOTAL_TIME=$((END_TIME - START_TIME))
          TOTAL_MIN=$((TOTAL_TIME / 60))
          TOTAL_SEC=$((TOTAL_TIME % 60))

          echo ""
          echo "üéâ Regeneration completed!"
          echo "üìà Total processed: ${PROCESSED} SVGs"
          echo "‚è±Ô∏è  Total time: ${TOTAL_MIN}m ${TOTAL_SEC}s"
