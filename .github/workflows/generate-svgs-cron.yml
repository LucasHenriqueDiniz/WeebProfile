name: Generate SVGs Cron

on:
  schedule:
    # Roda √†s 3h07 da manh√£ UTC (00h07 hor√°rio de Bras√≠lia)
    - cron: "7 3 * * *"
  workflow_dispatch: # Permite execu√ß√£o manual no GitHub

jobs:
  generate-svgs:
    runs-on: ubuntu-latest
    steps:
      - name: Regenerate all due SVGs (loop)
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          RAILWAY_URL: ${{ secrets.RAILWAY_URL }}
        run: |
          if [ -z "$CRON_SECRET" ]; then
            echo "‚ùå CRON_SECRET n√£o configurado"
            exit 1
          fi

          if [ -z "$RAILWAY_URL" ]; then
            echo "‚ùå RAILWAY_URL n√£o configurado"
            exit 1
          fi

          echo "üîÑ Starting regeneration loop..."

          # Loop at√© n√£o haver mais SVGs para processar
          for i in {1..20}; do
            echo "üì¶ Run $i"
            
            RES=$(curl -fsS --retry 5 --retry-all-errors --max-time 420 \
              -X POST \
              -H "Authorization: Bearer ${CRON_SECRET}" \
              -H "Content-Type: application/json" \
              "${RAILWAY_URL}/api/cron/generate-svgs?limit=50&timeboxMs=360000" || echo '{"hasMore":false}')
            
            echo "$RES"
            
            # Se o endpoint indicar que n√£o h√° mais trabalho, sai
            if echo "$RES" | grep -q '"hasMore":false'; then
              echo "‚úÖ No more SVGs to process, exiting loop"
              break
            fi
            
            # Pequena pausa entre requests
            sleep 5
          done

          echo "‚úÖ Regeneration loop completed"
